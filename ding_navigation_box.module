<?php

/**
 * @file
 * 
 * This module provides a smart naviagtion box as a block or ctools plugin.
 */

// Constants
define('DING_NAV_BOX_PATH', drupal_get_path('module', 'ding_navigation_box'));

include_once 'ding_navigation_box.features.inc';

/**
 * Implements hook_block_info().
 */
function ding_navigation_box_block_info() {
  $blocks = array();
  $blocks['ding_navigation_box'] = array(
    'info' => t('Ding navigation box'),  
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 * 
 * Ignoring $delta since we only have 1 block.
 */
function ding_navigation_box_block_view($delta) {
  $block = array();
  $block['subject'] = t('Ding navigation box');
  // Fetch ding-navigation-item node entities from the database.
  $items = _ding_navigation_box_get_items();
  $block['content']['ding_navigation_box'] = array(
    '#theme' => 'ding_navigation_box',
    'activation_areas' => $items['activation_areas'],
    'content_areas' => $items['content_areas'],
  );
  // Attach javascript
  foreach (_ding_navigation_box_get_javascript() as $js) {
    $block['content']['#attached']['js'][] = $js;
  }
  // Attach css
  foreach (_ding_navigation_box_get_css() as $css) {
    $block['content']['#attached']['css'][] = $css; 
  }
  return $block;
}

/**
 * Implements hook_theme().
 * 
 * Declares the theme hooks that renders the Ding navigation box.
 */
function ding_navigation_box_theme() {
  return array(
    'ding_navigation_box' => array(
      'render element' => 'element',
      'template' => 'ding-navigation-box',
      'path' => DING_NAV_BOX_PATH . '/templates',
    ),
    'ding_nav_box_activation_area' => array(
      'variables' => array(
        'item' => NULL,      
        'item_position' => 0,
      ),
      'template' => 'ding-nav-box-activation-area',
      'path' => DING_NAV_BOX_PATH . '/templates',  
    ),
    'ding_nav_box_content_area' => array(
      'variables' => array(
        'item' => NULL,      
        'item_position' => 0,
      ),
      'template' => 'ding-nav-box-content-area',
      'path' => DING_NAV_BOX_PATH . '/templates',   
    ),  
  );
}

/**
 * Module template preprocess funtion for the navigation box.
 */
function template_preprocess_ding_navigation_box(&$variables) {
  $element = $variables['element'];
  // If there's no items or content areas present dont render entries at all. 
  if (empty($element['activation_areas']) || empty($element['content_areas'])) {
    $variables['activation_areas'] = $variables['content_areas'] = FALSE;
  }
  // Else we setup the variables for the navigation box template.
  else {
    $variables['activation_areas'] = $element['activation_areas'];
    $variables['content_areas'] = $element['content_areas'];
  }
}

/**
 * Returns an array with all the css for the navigation box that can be used
 * on the attach property in a render array. 
 */
function _ding_navigation_box_get_css() {
  $css = array();
  $css_base = array(
    'type' => 'file',
    'group' => CSS_DEFAULT,  
  );
  $css[] = array(
    'data' => DING_NAV_BOX_PATH . '/css/ding-navigation-box.css',  
  ) + $css_base;
  $css[] = array(
    'data' => DING_NAV_BOX_PATH . '/css/ding-navigation-box-borders.css',  
  ) + $css_base;
  return $css;
}

/**
 * Returns an array with the javascript for the navigation box. This array can
 * be used on the attached property in a render array.
 */
function _ding_navigation_box_get_javascript() {
  $js = array();
  $js_base = array(
    'group' => JS_DEFAULT,
  );
  $js[] = array(
    'type' => 'file',
    'data' => DING_NAV_BOX_PATH . '/js/ding-navigation-box.js',
  ) + $js_base;
  $js[] = array(
    'type' => 'setting',
    'data' => array(
      'dingNavigationBox' => array(
        'defaultEntryIndex' => 1,
        'activationEvent' => 'mouseenter',  
      ),
    ),    
  ) + $js_base;
  return $js;
}

/**
 * Return an array with the entries for the navigation box setup as 
 * render-arrays.
 */
function _ding_navigation_box_get_items() {
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
        ->entityCondition('bundle', 'ding_navigation_item');
  $result = $query->execute();
  $items_result = array();
  $items_return['activation_areas'] = array();
  $items_return['content_areas'] = array();
  // Check to see if the query returned any navigation items. If so setup the 
  // return array with the activation areas and content-areas of each item 
  // prepared as render arrays.
  if (isset($result['node'])) {
    $item_nids = array_keys($result['node']);
    $items_result = node_load_multiple($item_nids);
    // Prepare the field data for display
    field_attach_prepare_view('node', $items_result, 'full');
    // Allow modules to act - invoke hook_entity_prepare_view().
    entity_prepare_view('node', $items_result);
    $i = 0;
    foreach ($items_result as $item) {
      $i++;
      // Build field content - Setup a renderarray for each field on the item.
      $item->content = field_attach_view('node', $item, 'full');
      $items_return['activation_areas'][] = array(
        '#theme' => 'ding_nav_box_activation_area',
        '#item' => $item,
        '#item_position' => $i,
      );
      $items_return['content_areas'][] = array(
        '#theme' => 'ding_nav_box_content_area',
        '#item' => $item,
        '#item_position' => $i,
      );
    }
  }
  return $items_return;
}







